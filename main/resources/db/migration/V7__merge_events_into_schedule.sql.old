-- V7: eventsテーブルをschedulesテーブルに統合
-- 目的: スケジュール管理を一元化し、手動登録とGoogle同期を統一的に扱う

-- ステップ1: schedulesテーブルに新しいカラムを追加
ALTER TABLE schedules
ADD COLUMN is_synced_from_google BOOLEAN DEFAULT FALSE COMMENT 'Googleカレンダーから同期されたスケジュールかどうか',
ADD COLUMN google_event_id VARCHAR(255) DEFAULT NULL COMMENT 'GoogleカレンダーのイベントID（同期時のみ）',
ADD COLUMN INDEX idx_google_event_id (google_event_id);

-- ステップ2: schedule_nameをtitleに変更（Google同期のフィールド名と統一）
ALTER TABLE schedules
CHANGE COLUMN schedule_name title VARCHAR(255) NOT NULL COMMENT 'スケジュールのタイトル';

-- ステップ3: eventsテーブルのデータをschedulesテーブルに移行
INSERT INTO schedules (
    user_id,
    title,
    start_time,
    end_time,
    task,
    memo,
    is_synced_from_google,
    google_event_id,
    created_at,
    updated_at,
    deleted_at
)
SELECT
    user_id,
    title,
    start_time,
    end_time,
    NULL AS task, -- eventsテーブルにはtaskがないのでNULL
    description AS memo, -- descriptionをmemoに対応
    TRUE AS is_synced_from_google, -- Google同期フラグをTRUEに設定
    google_event_id,
    created_at,
    updated_at,
    deleted_at
FROM events
WHERE deleted_at IS NULL; -- 論理削除されていないデータのみ移行

-- ステップ4: eventsテーブルを削除
DROP TABLE IF EXISTS events;

-- ステップ5: コメントを更新
ALTER TABLE schedules COMMENT = 'スケジュール管理テーブル（手動登録とGoogle同期を統合）';